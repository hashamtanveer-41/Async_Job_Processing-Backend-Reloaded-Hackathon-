import { z } from "zod";
import { JobStatus } from "../utils/errors.js";
import { RateLimiter } from "../utils/rate-limiter.js";
const startJobSchema = z.object({
  prompt: z.string().min(1, "Prompt is required").max(500, "Prompt too long"),
  options: z.object({
    temperature: z.number().min(0).max(1).optional(),
    maxTokens: z.number().min(1).max(4e3).optional()
  }).optional()
});
const config = {
  name: "StartAIJob",
  type: "api",
  path: "/ai/start",
  method: "POST",
  emits: ["ai.job.created"],
  flows: ["ai-jobs"],
  bodySchema: startJobSchema
};
const handler = async (req, { emit, state, logger }) => {
  try {
    const userId = "demo-user";
    const limitCheck = await RateLimiter.check(userId, state);
    if (!limitCheck.allowed) {
      logger.warn("Rate limit exceeded", { userId });
      return {
        status: 429,
        // "Too Many Requests"
        body: {
          error: "Rate Limit Exceeded",
          message: "You can only start 2 jobs per minute. Please wait."
        }
      };
    }
    const { prompt, options } = startJobSchema.parse(req.body);
    const jobId = `job-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    const timestamp = (/* @__PURE__ */ new Date()).toISOString();
    logger.info("Received Start Job Request", { jobId });
    const initialJobState = {
      jobId,
      status: JobStatus.PENDING,
      createdAt: timestamp,
      updatedAt: timestamp
    };
    await state.set("ai-jobs", jobId, initialJobState);
    await emit({
      topic: "ai.job.created",
      data: {
        jobId,
        prompt,
        options
      }
    });
    return {
      status: 201,
      body: {
        jobId,
        status: JobStatus.PENDING,
        message: "Job started successfully.",
        remaining_credits: limitCheck.remaining
      }
    };
  } catch (error) {
    logger.error("Failed to start job", { error });
    return {
      status: 500,
      body: { error: "Internal Server Error" }
    };
  }
};
export {
  config,
  handler
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vLi4vLi4vc3RlcHMvc3RhcnQtYWktam9iLnN0ZXAudHMiXSwKICAic291cmNlc0NvbnRlbnQiOiBbIi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XHJcbi8vIEZJTEU6IHNyYy9zdGVwcy9zdGFydC1haS1qb2Iuc3RlcC50c1xyXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxyXG5cclxuaW1wb3J0IHsgQXBpUm91dGVDb25maWcsIEhhbmRsZXJzIH0gZnJvbSAnbW90aWEnO1xyXG5pbXBvcnQgeyB6IH0gZnJvbSAnem9kJztcclxuaW1wb3J0IHsgSm9iU3RhdHVzLCBKb2JTdGF0ZSB9IGZyb20gJy4uL3V0aWxzL2Vycm9ycyc7XHJcbmltcG9ydCB7IFJhdGVMaW1pdGVyfSBmcm9tICcuLi91dGlscy9yYXRlLWxpbWl0ZXInO1xyXG5cclxuY29uc3Qgc3RhcnRKb2JTY2hlbWEgPSB6Lm9iamVjdCh7XHJcbiAgcHJvbXB0OiB6LnN0cmluZygpLm1pbigxLCAnUHJvbXB0IGlzIHJlcXVpcmVkJykubWF4KDUwMCwgJ1Byb21wdCB0b28gbG9uZycpLFxyXG4gIG9wdGlvbnM6IHoub2JqZWN0KHtcclxuICAgIHRlbXBlcmF0dXJlOiB6Lm51bWJlcigpLm1pbigwKS5tYXgoMSkub3B0aW9uYWwoKSxcclxuICAgIG1heFRva2Vuczogei5udW1iZXIoKS5taW4oMSkubWF4KDQwMDApLm9wdGlvbmFsKCksXHJcbiAgfSkub3B0aW9uYWwoKSxcclxufSk7XHJcblxyXG5leHBvcnQgY29uc3QgY29uZmlnOiBBcGlSb3V0ZUNvbmZpZyA9IHtcclxuICBuYW1lOiAnU3RhcnRBSUpvYicsXHJcbiAgdHlwZTogJ2FwaScsXHJcbiAgcGF0aDogJy9haS9zdGFydCcsXHJcbiAgbWV0aG9kOiAnUE9TVCcsXHJcbiAgZW1pdHM6IFsnYWkuam9iLmNyZWF0ZWQnXSxcclxuICBmbG93czogWydhaS1qb2JzJ10sXHJcbiAgYm9keVNjaGVtYTogc3RhcnRKb2JTY2hlbWEsXHJcbn07XHJcblxyXG5leHBvcnQgY29uc3QgaGFuZGxlcjogSGFuZGxlcnNbJ1N0YXJ0QUlKb2InXSA9IGFzeW5jIChyZXEsIHsgZW1pdCwgc3RhdGUsIGxvZ2dlciB9KSA9PiB7XHJcbiAgdHJ5IHtcclxuICAgIC8vIFx1RDgzRFx1REVFMVx1RkUwRiBSQVRFIExJTUlUIENIRUNLIChUaGUgQm91bmNlcilcclxuICAgIC8vIEluIGEgcmVhbCBhcHAsIHVzZSByZXEuaGVhZGVyc1sndXNlci1pZCddLiBGb3Igbm93LCB3ZSBzaW11bGF0ZSBhIHVzZXIuXHJcbiAgICBjb25zdCB1c2VySWQgPSBcImRlbW8tdXNlclwiOyBcclxuICAgIFxyXG4gICAgY29uc3QgbGltaXRDaGVjayA9IGF3YWl0IFJhdGVMaW1pdGVyLmNoZWNrKHVzZXJJZCwgc3RhdGUpO1xyXG5cclxuICAgIGlmICghbGltaXRDaGVjay5hbGxvd2VkKSB7XHJcbiAgICAgICAgbG9nZ2VyLndhcm4oJ1JhdGUgbGltaXQgZXhjZWVkZWQnLCB7IHVzZXJJZCB9KTtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBzdGF0dXM6IDQyOSwgLy8gXCJUb28gTWFueSBSZXF1ZXN0c1wiXHJcbiAgICAgICAgICAgIGJvZHk6IHsgXHJcbiAgICAgICAgICAgICAgICBlcnJvcjogJ1JhdGUgTGltaXQgRXhjZWVkZWQnLCBcclxuICAgICAgICAgICAgICAgIG1lc3NhZ2U6ICdZb3UgY2FuIG9ubHkgc3RhcnQgMiBqb2JzIHBlciBtaW51dGUuIFBsZWFzZSB3YWl0LicgXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgfVxyXG4gICAgY29uc3QgeyBwcm9tcHQsIG9wdGlvbnMgfSA9IHN0YXJ0Sm9iU2NoZW1hLnBhcnNlKHJlcS5ib2R5KTtcclxuXHJcbiAgICBjb25zdCBqb2JJZCA9IGBqb2ItJHtEYXRlLm5vdygpfS0ke01hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnN1YnN0cigyLCA5KX1gO1xyXG4gICAgY29uc3QgdGltZXN0YW1wID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpO1xyXG5cclxuICAgIGxvZ2dlci5pbmZvKCdSZWNlaXZlZCBTdGFydCBKb2IgUmVxdWVzdCcsIHsgam9iSWQgfSk7XHJcblxyXG4gICAgY29uc3QgaW5pdGlhbEpvYlN0YXRlOiBKb2JTdGF0ZSA9IHtcclxuICAgICAgam9iSWQsXHJcbiAgICAgIHN0YXR1czogSm9iU3RhdHVzLlBFTkRJTkcsXHJcbiAgICAgIGNyZWF0ZWRBdDogdGltZXN0YW1wLFxyXG4gICAgICB1cGRhdGVkQXQ6IHRpbWVzdGFtcCxcclxuICAgIH07XHJcblxyXG4gICAgYXdhaXQgc3RhdGUuc2V0KCdhaS1qb2JzJywgam9iSWQsIGluaXRpYWxKb2JTdGF0ZSk7XHJcblxyXG4gICAgLy8gRklYOiBDYXN0IGVtaXQgdG8gJ2FueScgdG8gYnlwYXNzIHRoZSBlcnJvciB1bnRpbCB0eXBlcyByZWdlbmVyYXRlXHJcbiAgICBhd2FpdCAoZW1pdCBhcyBhbnkpKHtcclxuICAgICAgdG9waWM6ICdhaS5qb2IuY3JlYXRlZCcsXHJcbiAgICAgIGRhdGE6IHtcclxuICAgICAgICBqb2JJZCxcclxuICAgICAgICBwcm9tcHQsXHJcbiAgICAgICAgb3B0aW9uc1xyXG4gICAgICB9LFxyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgc3RhdHVzOiAyMDEsXHJcbiAgICAgIGJvZHk6IHtcclxuICAgICAgICBqb2JJZCxcclxuICAgICAgICBzdGF0dXM6IEpvYlN0YXR1cy5QRU5ESU5HLFxyXG4gICAgICAgIG1lc3NhZ2U6ICdKb2Igc3RhcnRlZCBzdWNjZXNzZnVsbHkuJyxcclxuICAgICAgICByZW1haW5pbmdfY3JlZGl0czogbGltaXRDaGVjay5yZW1haW5pbmcgXHJcbiAgICAgIH0sXHJcbiAgICB9O1xyXG5cclxuICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgbG9nZ2VyLmVycm9yKCdGYWlsZWQgdG8gc3RhcnQgam9iJywgeyBlcnJvciB9KTtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIHN0YXR1czogNTAwLFxyXG4gICAgICBib2R5OiB7IGVycm9yOiAnSW50ZXJuYWwgU2VydmVyIEVycm9yJyB9LFxyXG4gICAgfTtcclxuICB9XHJcbn07Il0sCiAgIm1hcHBpbmdzIjogIkFBS0EsU0FBUyxTQUFTO0FBQ2xCLFNBQVMsaUJBQTJCO0FBQ3BDLFNBQVMsbUJBQWtCO0FBRTNCLE1BQU0saUJBQWlCLEVBQUUsT0FBTztBQUFBLEVBQzlCLFFBQVEsRUFBRSxPQUFPLEVBQUUsSUFBSSxHQUFHLG9CQUFvQixFQUFFLElBQUksS0FBSyxpQkFBaUI7QUFBQSxFQUMxRSxTQUFTLEVBQUUsT0FBTztBQUFBLElBQ2hCLGFBQWEsRUFBRSxPQUFPLEVBQUUsSUFBSSxDQUFDLEVBQUUsSUFBSSxDQUFDLEVBQUUsU0FBUztBQUFBLElBQy9DLFdBQVcsRUFBRSxPQUFPLEVBQUUsSUFBSSxDQUFDLEVBQUUsSUFBSSxHQUFJLEVBQUUsU0FBUztBQUFBLEVBQ2xELENBQUMsRUFBRSxTQUFTO0FBQ2QsQ0FBQztBQUVNLE1BQU0sU0FBeUI7QUFBQSxFQUNwQyxNQUFNO0FBQUEsRUFDTixNQUFNO0FBQUEsRUFDTixNQUFNO0FBQUEsRUFDTixRQUFRO0FBQUEsRUFDUixPQUFPLENBQUMsZ0JBQWdCO0FBQUEsRUFDeEIsT0FBTyxDQUFDLFNBQVM7QUFBQSxFQUNqQixZQUFZO0FBQ2Q7QUFFTyxNQUFNLFVBQWtDLE9BQU8sS0FBSyxFQUFFLE1BQU0sT0FBTyxPQUFPLE1BQU07QUFDckYsTUFBSTtBQUdGLFVBQU0sU0FBUztBQUVmLFVBQU0sYUFBYSxNQUFNLFlBQVksTUFBTSxRQUFRLEtBQUs7QUFFeEQsUUFBSSxDQUFDLFdBQVcsU0FBUztBQUNyQixhQUFPLEtBQUssdUJBQXVCLEVBQUUsT0FBTyxDQUFDO0FBQzdDLGFBQU87QUFBQSxRQUNILFFBQVE7QUFBQTtBQUFBLFFBQ1IsTUFBTTtBQUFBLFVBQ0YsT0FBTztBQUFBLFVBQ1AsU0FBUztBQUFBLFFBQ2I7QUFBQSxNQUNKO0FBQUEsSUFDSjtBQUNBLFVBQU0sRUFBRSxRQUFRLFFBQVEsSUFBSSxlQUFlLE1BQU0sSUFBSSxJQUFJO0FBRXpELFVBQU0sUUFBUSxPQUFPLEtBQUssSUFBSSxDQUFDLElBQUksS0FBSyxPQUFPLEVBQUUsU0FBUyxFQUFFLEVBQUUsT0FBTyxHQUFHLENBQUMsQ0FBQztBQUMxRSxVQUFNLGFBQVksb0JBQUksS0FBSyxHQUFFLFlBQVk7QUFFekMsV0FBTyxLQUFLLDhCQUE4QixFQUFFLE1BQU0sQ0FBQztBQUVuRCxVQUFNLGtCQUE0QjtBQUFBLE1BQ2hDO0FBQUEsTUFDQSxRQUFRLFVBQVU7QUFBQSxNQUNsQixXQUFXO0FBQUEsTUFDWCxXQUFXO0FBQUEsSUFDYjtBQUVBLFVBQU0sTUFBTSxJQUFJLFdBQVcsT0FBTyxlQUFlO0FBR2pELFVBQU8sS0FBYTtBQUFBLE1BQ2xCLE9BQU87QUFBQSxNQUNQLE1BQU07QUFBQSxRQUNKO0FBQUEsUUFDQTtBQUFBLFFBQ0E7QUFBQSxNQUNGO0FBQUEsSUFDRixDQUFDO0FBRUQsV0FBTztBQUFBLE1BQ0wsUUFBUTtBQUFBLE1BQ1IsTUFBTTtBQUFBLFFBQ0o7QUFBQSxRQUNBLFFBQVEsVUFBVTtBQUFBLFFBQ2xCLFNBQVM7QUFBQSxRQUNULG1CQUFtQixXQUFXO0FBQUEsTUFDaEM7QUFBQSxJQUNGO0FBQUEsRUFFRixTQUFTLE9BQU87QUFDZCxXQUFPLE1BQU0sdUJBQXVCLEVBQUUsTUFBTSxDQUFDO0FBQzdDLFdBQU87QUFBQSxNQUNMLFFBQVE7QUFBQSxNQUNSLE1BQU0sRUFBRSxPQUFPLHdCQUF3QjtBQUFBLElBQ3pDO0FBQUEsRUFDRjtBQUNGOyIsCiAgIm5hbWVzIjogW10KfQo=
